<html layout:decorate="~{layout-inner}">
    <main layout:fragment="content">
        <section id="title">
            <a href="/user/diet/log"><h3 th:text="${mdUser.nickname != null ? mdUser.nickname : mdUser.username} + '님의 밀땅일지'"></h3></a>
            <h1 classe="text-primary text-center pt-20 mb-10">식단 AI 분석을 시작합니다.</h1>
        </section>

        <section id="content" class="row align-items-md-stretch">
            <div id="uploader" class="col-md-6">
                <div id="upload-form">
                    <form id="uploadForm" name="form" enctype="multipart/form-data">
                        <input type="file" name="imgfile" onchange="setThumbnail(event);"/>
                        <!-- 파일 등록하면 자바스크립트 함수 실행됨 -->
                        <input type="button" id="submit" value="업로드"/>
                    </form>
                </div>
                <div id="upload-image" class="size-max-100">
                    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                    <script>
                    $(document).ready(function() {
                        $('#submit').click(function(e) {
                            e.preventDefault(); // 폼 기본 제출 방지
                            var formData = new FormData($('#uploadForm')[0]);
                            
                            $.ajax({
                                url: '/api-upload', // '/api-upload' 엔드포인트 사용
                                type: 'POST',
                                data: formData,
                                processData: false, // FormData 사용 시 필수
                                contentType: false, // FormData 사용 시 필수
                                success: function(response) {
                                    // 응답에서 imgUrl 속성 값을 가져와 img 요소의 src 속성에 할당합니다.
                                    $('#image').attr('src', response.imgUrl);
                                },
                                error: function(error) {
                                    console.log("이미지 업로드 실패:", error);
                                }
                            });
                        });
                    });
                    </script>
                </div>
                <a href="/user/diet/analysis/result"><button>분석 결과 확인</button></a>
            </div>
            <div id="result" class="col-md-6">
                <table>
                    <tr>
                        <td>분류된 이미지</td>
                        <td>분류된 이미지</td>
                        <td>분류된 이미지</td>
                    </tr>
                    <tr>
                        <td>영양정보</td>
                        <td>영양정보</td>
                        <td>영양정보</td>
                    </tr>
                    <tr>
                        <td> + </td>
                    </tr>
                </table>
                <a href="#" class="delete-btn"><button type="submit" id="delete-btn">삭제</button></a>
                <p>분석한 이미지는 자동으로 갤러리에 저장됩니다. 저장을 원하지 않으시면 삭제 버튼을 눌러주세요.</p>
                <p>하지만 아직 삭제 기능은 구현 안됐습니다 ^^</p>
            </div>
        </section>
        <script>
            // 업로드 이미지 미리보기
            function setThumbnail(event) {
            var reader = new FileReader();
        
            reader.onload = function(event) {
            var img = document.createElement("img");
            img.setAttribute("src", event.target.result);
            document.querySelector("#upload-image").appendChild(img);
            };
        
            reader.readAsDataURL(event.target.files[0]);
        }
        </script>
    </main>
</html>